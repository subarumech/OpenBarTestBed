{% extends "base.html" %}

{% block title %}Pour Recipe{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="container manual-pouring-container">
        <h1>Pour Recipe: <span id="recipe-name"></span></h1>
        <div class="pouring-container">
            <div class="pouring-section">
                <h3>Whiskey</h3>
                <div class="volume-selector">
                    <button class="volume-button" onclick="adjustVolume('whiskey', 0.25)">+</button>
                    <span id="whiskey-volume" class="volume-display">
                        <span class="volume-value">1.00</span> oz
                    </span>
                    <button class="volume-button" onclick="adjustVolume('whiskey', -0.25)">-</button>
                </div>
            </div>
            <div class="vertical-line"></div>
            <div class="pouring-section">
                <h3>Syrup</h3>
                <div class="volume-selector">
                    <button class="volume-button" onclick="adjustVolume('syrup', 0.25)">+</button>
                    <span id="syrup-volume" class="volume-display">
                        <span class="volume-value">1.00</span> oz
                    </span>
                    <button class="volume-button" onclick="adjustVolume('syrup', -0.25)">-</button>
                </div>
            </div>
            <div class="vertical-line"></div>
            <div class="pouring-section">
                <h3>Bitters</h3>
                <div class="volume-selector">
                    <button class="volume-button" onclick="adjustVolume('bitters', 1)">+</button>
                    <span id="bitters-volume" class="volume-display">1 dash</span>
                    <button class="volume-button" onclick="adjustVolume('bitters', -1)">-</button>
                </div>
            </div>
        </div>
        <div class="pour-all-container">
            <button id="pour-all-button" class="pour-all-button" onclick="pourAll()">Make Drink</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_URL = '';
    let recipe = null;

    function loadRecipe() {
        const recipeId = window.location.pathname.split('/').pop();
        fetch(`${API_URL}/api/recipes/${recipeId}`)
            .then(response => response.json())
            .then(data => {
                recipe = data;
                document.getElementById('recipe-name').textContent = recipe.name;
                document.querySelector('#whiskey-volume .volume-value').textContent = recipe.whiskey_volume.toFixed(2);
                document.querySelector('#syrup-volume .volume-value').textContent = recipe.syrup_volume.toFixed(2);
                document.getElementById('bitters-volume').textContent = `${recipe.bitters_volume} ${recipe.bitters_volume === 1 ? 'dash' : 'dashes'}`;
            })
            .catch(error => console.error('Error loading recipe:', error));
    }

    function adjustVolume(ingredient, change) {
        const volumeElement = document.getElementById(`${ingredient}-volume`);
        let currentVolume;
        if (ingredient === 'bitters') {
            currentVolume = parseInt(volumeElement.textContent);
        } else {
            currentVolume = parseFloat(volumeElement.querySelector('.volume-value').textContent);
        }
        currentVolume += change;
        if (currentVolume < 0) currentVolume = 0;
        if (ingredient === 'bitters') {
            if (currentVolume > 10) currentVolume = 10;
            volumeElement.textContent = `${currentVolume} ${currentVolume === 1 ? 'dash' : 'dashes'}`;
        } else {
            if (currentVolume > 4) currentVolume = 4;
            volumeElement.innerHTML = `<span class="volume-value">${currentVolume.toFixed(2)}</span> oz`;
        }
    }

    function pour(ingredient) {
        let volume;
        if (ingredient === 'bitters') {
            volume = parseInt(document.getElementById('bitters-volume').textContent);
        } else {
            volume = parseFloat(document.querySelector(`#${ingredient}-volume .volume-value`).textContent);
        }
        
        return fetch(`${API_URL}/pour`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ingredient: ingredient, volume: volume})
        }).then(response => response.json());
    }

    function wait(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function moveToPosition(position) {
        return fetch(`${API_URL}/move_to_position`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({position: position})
        }).then(response => response.json());
    }

    async function pourAll() {
        try {
            // Pour whiskey
            console.log('Pouring whiskey...');
            await pour('whiskey');
            await wait(1000);  // Wait 1 second

            // Pour syrup
            console.log('Pouring syrup...');
            await pour('syrup');
            await wait(1000);  // Wait 1 second

            // Pour bitters
            console.log('Pouring bitters...');
            await pour('bitters');
            await wait(1000);  // Wait 1 second

            // Move to position 4900
            console.log('Moving to final position...');
            await moveToPosition(4900);

            console.log('All pour operations completed successfully');
            alert('All ingredients poured successfully!');
        } catch (error) {
            console.error('Error during pour all operation:', error);
            alert('An error occurred while pouring ingredients. Please check the console for details.');
        }
    }

    loadRecipe();
</script>
{% endblock %}